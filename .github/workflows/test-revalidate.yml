name: Test Revalidate Endpoint

on:
  workflow_dispatch:
    inputs:
      slug:
        description: "Blog slug to revalidate (e.g. 30-question-security-audit-checklist-sme-it-managers)"
        required: true
        type: string
      site_url:
        description: "Base site URL"
        required: false
        default: "https://skynet-consulting.net"
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Call /api/revalidate
        env:
          SITE_URL: ${{ inputs.site_url }}
          SLUG: ${{ inputs.slug }}
          # Prefer token list if configured (supports rotation); fallback to single token.
          REVALIDATE_SECRETS: ${{ secrets.REVALIDATE_SECRETS }}
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${REVALIDATE_SECRETS:-}" ] && [ -z "${REVALIDATE_SECRET:-}" ]; then
            echo "❌ Missing GitHub secret: REVALIDATE_SECRET (or REVALIDATE_SECRETS)"
            echo "Add it in: Repo Settings → Secrets and variables → Actions"
            exit 1
          fi

          # Pick the first token if a list is provided.
          TOKEN="${REVALIDATE_SECRET:-}"
          if [ -n "${REVALIDATE_SECRETS:-}" ]; then
            TOKEN="${REVALIDATE_SECRETS%%,*}"
          fi

          # Avoid www -> apex redirect (drops or delays headers depending on client)
          SITE_URL="${SITE_URL/https:\/\/www.skynet-consulting.net/https:\/\/skynet-consulting.net}"
          SITE_URL="${SITE_URL/http:\/\/www.skynet-consulting.net/http:\/\/skynet-consulting.net}"

          echo "ℹ️  Calling ${SITE_URL}/api/revalidate for slug=${SLUG}"

          http_code=$(curl -sS -L -o response.json -w "%{http_code}" \
            -X POST "${SITE_URL}/api/revalidate" \
            -H "Content-Type: application/json" \
            -H "x-revalidate-secret: ${TOKEN}" \
            --data "{\"slug\":\"${SLUG}\"}")

          echo "HTTP ${http_code}"
          cat response.json || true
          echo

          if [ "${http_code}" != "200" ]; then
            echo "❌ Revalidate failed"
            exit 1
          fi

          echo "✅ Revalidate OK"
